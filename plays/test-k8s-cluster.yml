---
- hosts: localhost
  gather_facts: false
  tasks:
    # External services exposed internally
    - ansible.builtin.import_tasks: k8s/minio/tasks.yml
      tags:
        - minio

    # Internal services
    - ansible.builtin.import_tasks: k8s/purelb/tasks.yml
      tags:
        - purelb
    - ansible.builtin.import_tasks: k8s/cert-manager/tasks.yml
      tags:
        - cert-manager
      vars:
        certmanager_cloudflare_api_token: "{{ hostvars[groups['kairos_test'] | first].certmanager_cloudflare_api_token }}"
    - name: Setup traefik via Kustomize
      kubernetes.core.k8s:
        apply: yes
        context: "{{ cluster }}"
        definition: "{{ resource }}"
        state: present
      loop: "{{ lookup('kubernetes.core.kustomize', dir='kustomization/test/traefik/').split('---\n') | map('from_yaml') }}"
      loop_control:
        label: "{{ resource.apiVersion }}.{{ resource.kind }} {{ resource.metadata.name }}"
        loop_var: resource
      tags:
        - traefik
    - ansible.builtin.import_tasks: k8s/longhorn/tasks.yml
      tags:
        - longhorn
      vars:
        longhorn_default_crypto_passphrase: "{{ hostvars[groups['kairos_test'] | first].longhorn_default_crypto_passphrase }}"
        longhorn_s3: "{{ hostvars[groups['kairos_test'] | first].longhorn_s3 }}"
    - ansible.builtin.import_tasks: k8s/rabbitmq-operator/tasks.yml
      tags:
        - rabbitmq
    - ansible.builtin.import_tasks: k8s/unifi/tasks.yml
      tags:
        - unifi
  vars:
    # Right now, I only have the test cluster, but this will need to change in the future!
    cluster: default
    kustomization_overlay: test
