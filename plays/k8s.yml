---
# Login first with this command:
# kubectl vsphere login --vsphere-username administrator@vsphere.local --server=10.96.0.130 --insecure-skip-tls-verify
# Post cluster creation, you need to do this:
# kubectl vsphere login --server=10.96.0.130 --tanzu-kubernetes-cluster-name test-cluster01 --tanzu-kubernetes-cluster-namespace lab --vsphere-username administrator@vsphere.local --insecure-skip-tls-verify
- hosts: localhost
  gather_facts: false
  tasks:
    - name: Setup cluster
      kubernetes.core.k8s:
        context: 10.96.0.130
        api_version: run.tanzu.vmware.com/v1alpha3
        apply: yes
        validate_certs: no
        kind: TanzuKubernetesCluster
        resource_definition:
          metadata:
            name: test-cluster01
            namespace: lab
          spec:
            distribution:
              version: v1.22
            topology:
              controlPlane:
                replicas: 3
                vmClass: guaranteed-xsmall
                storageClass: vsan-default-storage-policy
              nodePools:
                - name: workers
                  replicas: 2
                  vmClass: best-effort-large
                  storageClass: vsan-default-storage-policy

    # Per Example 2 at
    # https://docs.vmware.com/en/VMware-vSphere/7.0/vmware-vsphere-with-tanzu/GUID-4CCDBB85-2770-4FB8-BF0E-5146B45C9543.html
    - name: Create a RoleBinding to allow service accounts within the default namespace to run privileged workloads
      kubernetes.core.k8s:
        api_version: rbac.authorization.k8s.io/v1
        context: test-cluster01
        kind: RoleBinding
        name: rolebinding-default-privileged-sa-ns_default
        namespace: default
        resource_definition:
          roleRef:
            apiGroup: rbac.authorization.k8s.io
            kind: ClusterRole
            name: psp:vmware-system-privileged
          subjects:
          - apiGroup: rbac.authorization.k8s.io
            kind: Group
            name: system:serviceaccounts


- ansible.builtin.import_playbook: k8s/traefik.yml
  vars:
    cluster: test-cluster01
  tags:
    - traefik
- ansible.builtin.import_playbook: k8s/nginx-test.yml
  vars:
    cluster: test-cluster01
- ansible.builtin.import_playbook: k8s/minecraft.yml
  vars:
    cluster: test-cluster01
