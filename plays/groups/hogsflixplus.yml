---
- hosts: hogsflixplus
  roles:
    - role: common-users
    - become: yes
      netplan_configuration:
        network:
          ethernets:
            eth0:
              dhcp4: true
          tunnels:
            wg_hogsflixplus:
              addresses:
                - "{{ wireguard__address }}"
              key: "{{ wireguard__privkey }}"
              mode: wireguard
              peers:
                - allowed-ips:
                    - 10.10.0.20/32 # sdwilsh-dev.hogs.tswn.us
                    - 10.11.1.1/32 # jellyfin
                    - 172.31.42.1/32 # tartarus01 wireguard tunnel address
                  endpoint: 149.248.37.12:51823
                  keepalive: 25
                  keys:
                    public: "{{ hostvars['tartarus01.tswn.us'].wireguard__pubkey }}"
              routes:
                - to: 10.10.0.20/32 # sdwilsh-dev.hogs.tswn.us
                  via: 172.31.42.1
                - to: 10.11.1.1/32 # jellyfin
                  via: 172.31.42.1
          version: 2
      role: mrlesmithjr.netplan
  tasks:
    - name: Disable cloud-init
      ansible.builtin.copy:
        content: ""
        dest: /etc/cloud/cloud-init.disabled
      become: yes
    - name: Install WireGuard
      ansible.builtin.apt:
        name: wireguard
        state: present
      become: yes
