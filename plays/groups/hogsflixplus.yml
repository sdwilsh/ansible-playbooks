---
- name: Play for hogsflixplus hosts
  become: true
  hosts: hogsflixplus
  handlers:
    # Note: these run in the order they are defined in (regardless of invocation order)!
    - name: systemctl daemon-reload
      ansible.builtin.systemd_service:
        daemon_reload: true
    - name: alloy.service
      ansible.builtin.systemd_service:
        name: alloy.service
        state: restarted
    - name: systemd-journald.service
      ansible.builtin.systemd_service:
        name: systemd-journald.service
        state: restarted
    - name: systemd-modules-load.service
      ansible.builtin.systemd_service:
        name: systemd-modules-load.service
        state: restarted
    - name: systemd-sysctl.service
      ansible.builtin.systemd_service:
        name: systemd-sysctl.service
        state: restarted
    - name: reload hfp network
      ansible.builtin.nmcli:
        conn_name: hfp
        conn_reload: true
        state: up
    - name: hfp-proxy.service
      ansible.builtin.systemd_service:
        name: hfp-proxy.service
        state: restarted
    - name: reboot
      ansible.builtin.reboot:
        test_command: "{{ reboot_test_command }}"
  roles:
    - role: common-users
    - role: devsec.hardening.ssh_hardening
      vars:
        ssh_kerberos_support: false
        ssh_listen_to:
          - 0.0.0.0
  tasks:
    - name: Set Hostname
      ansible.builtin.hostname:
        name: "{{ inventory_hostname }}"
    - name: Update to latest mack image
      community.general.bootc_manage:
        image: ghcr.io/sdwilsh/mack:latest
        state: switch
      become: true
      notify:
        - reboot
      tags:
        - bootc
    - name: Ensure directories exist
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: u=rw,g=r,o=r
        owner: root
        group: root
      loop:
        - /etc/containers/systemd/alloy.container.d
        - /etc/jellyfin-remote-proxy
        - /etc/systemd/journald.conf.d
      tags:
        - alloy
        - hfp-proxy
    - name: Setup loading of additional kernel modules needed by Wireguard
      ansible.builtin.copy:
        content: |
          wireguard
          # iptables/nftables modules for basic DNAT/SNAT and masquerading
          nft_chain_nat
          nft_compat
          xt_nat
          # nftables modules for wg-quick default route
          nft_ct
          nft_fib_ine
        dest: /etc/modules-load.d/wireguard.conf
        mode: u=rw,g=r,o=r
        owner: root
        group: root
      notify:
        - systemd-modules-load.service
      tags:
        - hfp-wireguard
        - modules-load
    - name: Setup HFP Wireguard Connection
      community.general.nmcli:
        autoconnect: true
        conn_name: hfp
        ifname: hfp0
        ip4: "{{ wireguard__address }}"
        type: wireguard
        state: present
        wireguard:
          fwmark: 0x00acab00
          ip4-auto-default-route: true
          mtu: 1280
          peer-routes: true
          private-key: "{{ wireguard__privkey }}"
      tags:
        - hfp-wireguard
    - name: Add Wireguard Peer
      ansible.builtin.blockinfile:
        append_newline: true
        block: |
          [wireguard-peer.{{ wireguard__pubkey }}]
          allowed-ips={{ allowed_ips | join(';') }};
          endpoint=hogsflixplus.tswn.us:51823
        insertafter: EOF
        path: /etc/NetworkManager/system-connections/hfp.nmconnection
        state: present
      no_log: true # Contains the wireguard private key!
      notify:
        - reload hfp network
      tags:
        - hfp-wireguard
      vars:
        allowed_ips:
          - 10.11.2.1/32 # Gateway
          - 10.11.1.1/32 # Jellyfin
          - 10.11.1.72/32 # loki-distributor
          - 10.117.0.9/32 # lighterthansome
        wireguard__pubkey: Dwdz7rWR4y8uMW3s4MWZwe1+rR0Bqiigms7Aku51ghU=
    - name: Configure jellyfin-remote-proxy
      ansible.builtin.copy:
        content: "{{ config | to_nice_yaml(indent=2, explicit_start=True) }}"
        dest: /etc/jellyfin-remote-proxy/config.yml
        mode: u=r,g=r
        owner: root
        group: root
      notify:
        - systemctl daemon-reload
        - hfp-proxy.service
      tags:
        - hfp-proxy
      vars:
        config:
          local:
            port: 8080
          remote:
            address: 10.11.1.1
            port: 8096
    - name: Setup HFP proxy container
      ansible.builtin.copy:
        content: |
          [Unit]
          After=network-online.target
          ConditionPathExists=/etc/jellyfin-remote-proxy/config.yml
          Description=A container that proxies jellyfin to the local network.

          [Install]
          WantedBy=multi-user.target default.target

          [Container]
          DropCapability=ALL
          Environment="RUST_LOG=INFO"
          Exec=/usr/local/etc/jellyfin-remote-proxy/config.yml
          HealthCmd=CMD-SHELL curl http://localhost:8080/health || exit 1
          HealthInterval=60s
          HealthOnFailure=restart
          HealthStartPeriod=15s
          Image=ghcr.io/sdwilsh/jellyfin-remote-proxy:{{ jellyfin_remote_proxy_version }}
          NoNewPrivileges=true
          PublishPort=80:8080/tcp
          PublishPort=7359:7359/udp
          Volume=/etc/jellyfin-remote-proxy/config.yml:/usr/local/etc/jellyfin-remote-proxy/config.yml:Z
        dest: /etc/containers/systemd/hfp-proxy.container
        mode: u=rw,g=r,o=r
        owner: root
        group: root
      notify:
        - systemctl daemon-reload
        - hfp-proxy.service
      tags:
        - hfp-proxy
      vars:
        # renovate: datasource=github-releases depName=sdwilsh/jellyfin-remote-proxy
        jellyfin_remote_proxy_version: v0.1.9

    # Node Monitoring
    - name: Modify Alloy container to setup config
      ansible.builtin.copy:
        content: |
          [Install]
          WantedBy=multi-user.target default.target

          [Container]
          Environment=HOST_HOSTNAME={{ inventory_hostname }}
          Volume=/etc/alloy/loki.alloy:/etc/alloy/loki.alloy:ro
        dest: /etc/containers/systemd/alloy.container.d/override.conf
        mode: u=rw,g=r,o=r
        owner: root
        group: root
      notify:
        - alloy.service
        - systemctl daemon-reload
      tags:
        - alloy
    - name: Configure Loki target
      ansible.builtin.copy:
        content: |
          loki.write "default" {
            endpoint {
              url = "http://10.11.1.72:3100/loki/api/v1/push"
            }
          }
        dest: /etc/alloy/loki.alloy
        mode: u=rw,g=r,o=r
        owner: root
        group: root
      notify:
        - alloy.service
      tags:
        - alloy
    - name: Install journald.conf for Alloy
      ansible.builtin.copy:
        content: |
          [Journal]
          # Alloy pod will read from journalctl.
          ForwardToSyslog=no

          # Alloy should be ingesting this, but keep a bit extra just in case!
          MaxRetentionSec=7day
        dest: /etc/systemd/journald.conf.d/alloy.conf
        mode: u=rw,g=r,o=r
        owner: root
        group: root
      notify:
        - systemd-journald.service
      tags:
        - alloy
