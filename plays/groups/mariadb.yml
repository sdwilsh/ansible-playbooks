---
- hosts: mariadb
  roles:
    - role: mrlesmithjr.zfs
      become: yes
      tags:
        - zfs
    - role: mrlesmithjr.mariadb_galera_cluster
      become: yes
      tags:
        - mariadb
        - galera
  tasks:
    # One-off tasks for databases and users that don't make sense elsewhere.
    - name: Setup database for Home Assistant
      community.mysql.mysql_db:
        name: homeassistant
        state: present
        login_password: "{{ mariadb_mysql_root_password }}"
        login_unix_socket: /var/run/mysqld/mysqld.sock
        login_user: root
      run_once: yes
      tags:
        - mariadb
    - name: Setup database users for Home Assistant
      no_log: yes
      community.mysql.mysql_user:
        name: "{{ db_user.name }}"
        host: cortana.hogs.tswn.us
        password: "{{ db_user.password }}"
        priv: "{{ db_user.priv }}"
        login_password: "{{ mariadb_mysql_root_password }}"
        login_unix_socket: /var/run/mysqld/mysqld.sock
        login_user: root
        state: present
      run_once: yes
      tags:
        - mariadb
      vars:
        db_user:
          name: homeassistant
          password: !vault |
                $ANSIBLE_VAULT;1.1;AES256
                66623263623135303932386330396266313362333338373964616435386230623062623133383861
                6263333537373862653935623935353831303439663233350a626562653963643939616137623734
                37396563333633386538643062306637636339616532623166666335656561623137656538656236
                6332376361353937380a383666323230396362306363303831346236646530636163323062643339
                64656439666665343466616532633639613466313439666665373839626634333534
          priv:
            homeassistant.*: ALL
