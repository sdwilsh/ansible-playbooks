---
- hosts: kairos
  gather_facts: false
  order: sorted
  tasks:
    - name: Ensure configuration is up-to-date
      ansible.builtin.template:
        dest: /oem/90_custom.yaml
        src: templates/config.yml.j2
      become: yes
      register: config
      vars:
        host: "{{ inventory_hostname }}"
    - name: Read in current version
      ansible.builtin.slurp:
        src: /etc/os-release
      register: osreleasefile
    - name: Extract current version
      ansible.builtin.set_fact:
        os_release: "{{ osreleasefile['content'] | b64decode | regex_findall('^KAIROS_VERSION=\"(.*)\"$', multiline=True) | first }}"
    - name: Print os version
      ansible.builtin.debug:
        var: os_release
    - name: Install update
      ansible.builtin.command:
        argv:
          - kairos-agent
          - upgrade
          # v1.6.1-k3sv1.26.1+k3s1 => v1.6.1-k3sv1.26.1-k3s1
          - "{{ kairos_version | replace('+', '-') }}"
      become: yes
      when: os_release != kairos_version
    - name: Reboot
      ansible.builtin.reboot:
        pre_reboot_delay: 60 # seconds
        connect_timeout: 240 # seconds
        test_command: "{{ reboot_test_command }}"
      become: yes
      # At most one reboot at a time
      throttle: 1
      when: os_release != kairos_version or config.changed
  vars:
    # renovate: depName=quay.io/kairos/kairos-ubuntu-22-lts
    kairos_version: "v2.0.3-k3sv1.26.4+k3s1"
