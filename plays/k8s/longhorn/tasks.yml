---
- name: Create a namespace for Longhorn
  kubernetes.core.k8s:
    apply: yes
    context: "{{ cluster }}"
    state: present
    resource_definition:
      api_version: v1
      kind: Namespace
      metadata:
        name: longhorn-system
- name: Create Secret for the bucket target
  kubernetes.core.k8s:
    context: "{{ cluster }}"
    resource_definition:
      api_version: v1
      kind: Secret
      metadata:
        name: backup-target-credentials
        namespace: longhorn-system
      stringData:
        AWS_ACCESS_KEY_ID: "{{ longhorn_s3.access_key }}"
        AWS_SECRET_ACCESS_KEY: "{{ longhorn_s3.secret_key }}"
        AWS_ENDPOINTS: http://minio-svc.default.svc.cluster.local:9000
      type: Opaque
    state: present
- name: Configure global encryption key
  kubernetes.core.k8s:
    apply: yes
    context: "{{ cluster }}"
    resource_definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: longhorn-default-crypto
        namespace: longhorn-system
      stringData:
        CRYPTO_KEY_VALUE: "{{ longhorn_default_crypto_passphrase }}"
        CRYPTO_KEY_PROVIDER: secret
- name: Setup Longhorn via Kustomize
  kubernetes.core.k8s:
    apply: yes
    context: "{{ cluster }}"
    definition: "{{ resource }}"
    state: present
  loop: "{{ lookup('kubernetes.core.kustomize', dir='kustomization/' + kustomization_overlay + '/longhorn/').split('---\n') | map('from_yaml') }}"
  loop_control:
    label: "{{ resource.apiVersion }}.{{ resource.kind }} {{ resource.metadata.name }}"
    loop_var: resource
