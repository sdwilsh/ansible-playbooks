---
- name: Install cert-manager via Kustomize
  kubernetes.core.k8s:
    context: "{{ cluster }}"
    definition: "{{ resource }}"
    state: present
  loop: "{{ lookup('kubernetes.core.kustomize', dir='plays/k8s/cert-manager/').split('---\n') | map('from_yaml') }}"
  loop_control:
    label: "{{ resource.apiVersion }}.{{ resource.kind }} {{ resource.metadata.name }}"
    loop_var: resource
- name: Create Secret for the Cloudflare API Token
  kubernetes.core.k8s:
    api_version: v1
    context: "{{ cluster }}"
    kind: Secret
    name: cloudflare-api-token-secret
    namespace: cert-manager
    resource_definition:
      stringData:
        api-token: "{{ certmanager_cloudflare_api_token }}"
      type: Opaque
    state: present
