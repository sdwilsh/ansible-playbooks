---
# tasks file for docker-esphome
- name: Create esphome group
  ansible.builtin.group:
    name: esphome
    state: present
- name: Create esphome user
  ansible.builtin.user:
    name: esphome
    group: esphome
    groups:
      - docker
      - esphome
    state: present
    shell: /bin/bash

- name: Create esphome directory
  ansible.builtin.file:
    path: /opt/esphome
    state: directory
    owner: esphome
    group: esphome

- name: Get esphome user info
  ansible.builtin.getent:
    database: passwd
    key: esphome
- name: Storing esphome UID and GID
  ansible.builtin.set_fact:
    esphome_uid: "{{ getent_passwd[\"esphome\"].1 }}"
    esphome_gid: "{{ getent_passwd[\"esphome\"].2 }}"
- name: Launch esphome container
  community.docker.docker_compose:
    project_name: esphome
    definition:
      version: "2"
      services:
        bedrock:
          dns:
            - 10.117.0.1
          environment:
            - "PUID={{ esphome_uid }}"
            - "PGID={{ esphome_gid }}"
          image: esphome/esphome:stable
          mac_address: 02:42:0a:75:00:25
          networks:
            home:
              ipv4_address: 10.117.0.28
          ports:
            - 80:6052
          volumes:
            - /opt/esphome:/config
            - /etc/localtime:/etc/localtime:ro
      networks:
        home:
          external:
            name: home
    pull: yes
  vars:
    ansible_python_interpreter: /usr/bin/env python3-docker
  register: status
- ansible.builtin.assert:
    that:
      - status.services.bedrock.esphome_bedrock_1.state.running
