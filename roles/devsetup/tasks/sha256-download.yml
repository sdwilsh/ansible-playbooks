---
- name: Ensure download directory exists
  ansible.builtin.file:
    group: sdwilsh
    owner: sdwilsh
    path: ~sdwilsh/.local/download
    state: directory
- name: Fetch sha256
  ansible.builtin.get_url:
    dest: "~sdwilsh/.local/download/{{ item.executable }}.sha256"
    group: sdwilsh
    owner: sdwilsh
    url: "{{ item.sha256 }}"
  register: fetch_sha256 
- name: Consume archive sha256
  ansible.builtin.slurp:
    src: "~sdwilsh/.local/download/{{ item.executable }}.sha256"
  register: sha256
- name: Fetch archive
  ansible.builtin.get_url:
    checksum: "sha256:{{ sha256['content'] | b64decode | trim }}"
    dest: "~sdwilsh/.local/download/{{ item.executable }}.tar.gz"
    group: sdwilsh
    owner: sdwilsh
    url: "{{ item.targz }}"
  register: fetch_archive
  when: "'targz' in item"
- name: Install
  ansible.builtin.unarchive:
    dest: ~sdwilsh/.local/bin/
    group: sdwilsh
    owner: sdwilsh
    remote_src: yes
    src: "~sdwilsh/.local/download/{{ item.executable }}.tar.gz"
  when: fetch_archive.changed
