---
# zfs-auto-snapshot configuration
- name: Adjust zfs-auto-snapshot montly retention
  ansible.builtin.replace:
    path: /etc/cron.monthly/zfs-auto-snapshot
    regexp: --keep=(?!3)[0-9]+
    replace: --keep=3
  become: yes
  tags:
    - snapshots
    - zfs

# Encryption Keys Setup
- name: Create ZFS key directory for each pool's datasets
  ansible.builtin.file:
    path: "/usr/local/etc/zfs/keys/{{ pool.name }}/datasets"
    state: "{% if pool.state == 'present' %}directory{% else %}absent{% endif %}"
    owner: root
    group: root
    mode: u=rx,g=rx
  become: yes
  loop: "{{ zfs_pools }}"
  loop_control:
    label: "{{ pool.name }}"
    loop_var: pool
  tags:
    - zfs
  when: zfs_create_pools
- name: Create dataset key file
  ansible.builtin.copy:
    content: "{{ common__zfs_dataset_keys[dataset.pool][dataset.name].key }}"
    dest: "/usr/local/etc/zfs/keys/{{ dataset.pool }}/datasets/{{ dataset.name }}"
    owner: root
    group: root
    mode: u=r,g=r
  become: yes
  loop: "{{ zfs_filesystems }}"
  loop_control:
    label: "/usr/local/etc/zfs/keys/{{ dataset.pool }}/datasets/{{ dataset.name }}"
    loop_var: dataset
  tags:
    - zfs
  when:
    - zfs_create_filesystems | default(False)
    - "'keylocation' in dataset"
    - dataset.state == 'present'
