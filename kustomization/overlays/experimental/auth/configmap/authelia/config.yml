---
# yaml-language-server: $schema=https://www.authelia.com/schemas/v4.39/json-schema/configuration.json
# https://www.authelia.com/configuration/first-factor/introduction/
authentication_backend:
  ldap:
    address: ldap://lldap-svc:389
    base_dn: DC=tswn,DC=us
    implementation: lldap
    user: UID=authelia,OU=people,DC=tswn,DC=us
  password_reset:
    disable: false

# https://www.authelia.com/configuration/security/access-control/
access_control:
  default_policy: deny
  networks:
    - name: cluster
      networks:
        - 172.16.0.0/16
        - 172.17.0.0/16
    - name: dev
      networks:
        - 10.117.0.9 # lighterthansome.hogs.tswn.us
    - name: home
      networks:
        - 10.117.0.0/23
        - 10.117.2.1/24
    - name: homeassistant-appliance
      networks:
        - 10.117.0.33
    - name: kubernetes
      networks:
        - 10.11.0.0/23
    - name: man
      networks:
        - 10.10.0.0/24
    - name: sonos
      networks:
        - 10.117.0.60 # sonos-den.hogs
        - 10.117.0.61 # sonos-den-sub.hogs
        - 10.117.0.62 # sonos-living.hogs
        - 10.117.0.63 # sonos-living-sub.hogs
        - 10.117.0.66 # sonos-move.hogs
        - 10.117.0.67 # sonos-mainbed.hogs
        - 10.117.0.68 # sonos-office.hogs
        - 10.117.0.69 # sonos-dining.hogs
  rules:
    - domain: argo-cd.hogs.tswn.us
      networks:
        - home
      policy: bypass
    - domain: atuin.tswn.us
      policy: bypass
    - domain: frigate.hogs.tswn.us
      networks:
        - homeassistant-appliance
      policy: bypass
    - domain: homeassistant.hogs.tswn.us
      networks:
        - home
      policy: bypass
    - domain: immich.tswn.us
      policy: bypass
      resources:
        - ^/.well-known/immich$
        - ^/api/.*$
    - domain: jellyfin.tswn.us
      networks:
        - home
      policy: bypass
    - domain: opensprinkler.hogs.tswn.us
      networks:
        - home
        - homeassistant-appliance
      policy: bypass
    - domain: spoolman.hogs.tswn.us
      networks:
        - homeassistant-appliance
      policy: bypass
    - domain: "*.tswn.us"
      networks:
        - home
      policy: one_factor
    - domain: "*.tswn.us"
      policy: two_factor

identity_providers:
  oidc:
    clients:
      # https://www.authelia.com/integration/openid-connect/clients/argocd/
      - access_token_signed_response_alg: none
        authorization_policy: two_factor
        client_id: argocd
        client_name: Argo CD
        client_secret: $pbkdf2-sha512$310000$V1TXhcVzq2u8HjL4TVDrEQ$H6I9r.US8I841kfBPzEc0qkSR9iIljsMWxRdkLf0WfpQQrzz925qp47pFCGag3BCmf9OPSWFBd4U9lUa87VRXA
        grant_types:
          - authorization_code
        pkce_challenge_method: S256
        public: false
        redirect_uris:
          - https://argo-cd.hogs.tswn.us/auth/callback
        require_pkce: true
        response_types:
          - code
        scopes:
          - email
          - groups
          - openid
        token_endpoint_auth_method: client_secret_post
        userinfo_signed_response_alg: none
      - access_token_signed_response_alg: none
        authorization_policy: two_factor
        client_id: argocd-cli
        client_name: Argo CD (CLI)
        grant_types:
          - authorization_code
          - refresh_token
        pkce_challenge_method: S256
        public: true
        require_pkce: true
        redirect_uris:
          - http://localhost:8085/auth/callback
        response_types:
          - code
        scopes:
          - email
          - groups
          - offline_access
          - openid
        token_endpoint_auth_method: none
        userinfo_signed_response_alg: none
      # https://www.authelia.com/integration/openid-connect/clients/immich/
      - authorization_policy: two_factor
        client_id: brbyX~8fJ1lZxp1ixZ4M5XeEgyzxmc5C-BietrJdGT8Hjr1Fw1R42iPPh3Dq3XznSSuajcWG
        client_name: Immich
        client_secret: $pbkdf2-sha512$310000$omxinbTJUu.5YlmzWZTyhw$n5isxHk/CeWL9EhtQppgnyUUBlGO64icMFj26ZGj4ekwnbg.tunfss9t4kRHOhWyOd.3EQnfJKFngXM8A/pqeQ
        public: false
        redirect_uris:
          - app.immich:///oauth-callback
          - https://immich.tswn.us/auth/login
          - https://immich.tswn.us/auth/user-settings
        scopes:
          - email
          - openid
          - profile
        token_endpoint_auth_method: client_secret_post
        userinfo_signed_response_alg: none
      # https://www.authelia.com/integration/openid-connect/clients/nextcloud/#openid-connect-user-backend-app
      - access_token_signed_response_alg: none
        authorization_policy: two_factor
        client_id: fr7~9UoZ_cXqdcUpB_MgysiYMuVZqJW3PLxgdlHnWUq2q05KaV3I.RGXyVP0WMomxDruQO1o
        client_name: NextCloud
        client_secret: $pbkdf2-sha512$310000$sG/bEwoICRr33qf9g.bgMQ$VQAD07hXEzLCE29apKwhV/.yCbO5BTJ5gwDtGoNKh52e4Z7C23eRGuP9q1rmmOZovUUOLpQwjI7Bkq/.kY6l5w
        grant_types:
          - authorization_code
        pkce_challenge_method: S256
        public: false
        redirect_uris:
          - https://nextcloud.tswn.us/apps/user_oidc/code
        require_pkce: true
        response_types:
          - code
        scopes:
          - email
          - groups
          - openid
          - profile
        token_endpoint_auth_method: client_secret_post
        userinfo_signed_response_alg: none
      # OpenCloud, but it needs two clients!
      - audience: []
        authorization_policy: two_factor
        client_id: OpenCloudWeb
        client_name: OpenCloud
        consent_mode: auto
        grant_types:
          - authorization_code
          - refresh_token
        pre_configured_consent_duration: 1w
        public: true
        redirect_uris:
          - https://cloud.tswn.us/
          - https://cloud.tswn.us/oidc-callback.html
          - https://cloud.tswn.us/oidc-silent-redirect.html
        response_modes:
          - form_post
          - fragment
          - query
        response_types:
          - code
        scopes:
          - email
          - groups
          - offline_access
          - openid
          - profile
        userinfo_signed_response_alg: none
      - audience: []
        authorization_policy: one_factor
        client_id: OpenCloudDesktop
        client_name: OpenCloud Desktop Client
        consent_mode: auto
        grant_types:
          - authorization_code
          - refresh_token
        pre_configured_consent_duration: 1w
        public: true
        redirect_uris:
          - http://127.0.0.1
        response_types:
          - code
        response_modes:
          - form_post
        scopes:
          - email
          - groups
          - offline_access
          - openid
          - profile
        userinfo_signed_response_alg: none
      # https://www.authelia.com/integration/openid-connect/opkssh/
      - access_token_signed_response_alg: none
        authorization_policy: two_factor
        client_id: U.~.pIkNP_pYOYhauWcH1klEtbEagrtpse~eFgeGncUsugCXkZtiiZVqOSiEs7acspBclRuU
        client_name: opkssh 
        grant_types:
          - authorization_code
          - refresh_token
        pkce_challenge_method: S256
        public: true
        redirect_uris:
          - http://127.0.0.1:3000/login-callback
          - http://127.0.0.1:10001/login-callback
          - http://127.0.0.1:11110/login-callback
        response_types:
          - code
        require_pkce: true
        scopes:
          - offline_access
          - openid
        token_endpoint_auth_method: none
        userinfo_signed_response_alg: none
    cors:
      allowed_origins:
        - https://cloud.tswn.us
      endpoints:
        - token
    jwks:
      - algorithm: RS256
        key: {{ secret "/secrets/identity_providers_oidc_jwks_rsa4096_key" | mindent 10 "|" | msquote }}

# ---
# https://www.authelia.com/configuration/miscellaneous/logging/
log:
  format: json
  level: info

# https://www.authelia.com/configuration/notifications/introduction/
notifier:
  smtp:
    address: submission://proton-bridge-svc.proton-mail.svc.cluster.local:25
    sender: no-reply@tswn.us
    tls:
      skip_verify: true

ntp:
  address: udp://pool.ntp.hogs.tswn.us:123
  version: 4

# https://www.authelia.com/configuration/miscellaneous/server/
server:
  buffers:
    read: 8192

# https://www.authelia.com/configuration/session/introduction/
session:
  cookies:
    - domain: tswn.us
      authelia_url: https://auth.tswn.us
      inactivity: 60m
      expiration: 4h
  redis:
    high_availability:
      sentinel_name: myMaster
      nodes:
        - host: authelia-redis-sentinel-0.authelia-redis-sentinel-headless.auth.svc.cluster.local
          port: 26379
        - host: authelia-redis-sentinel-1.authelia-redis-sentinel-headless.auth.svc.cluster.local
          port: 26379
        - host: authelia-redis-sentinel-2.authelia-redis-sentinel-headless.auth.svc.cluster.local
          port: 26379
    host: authelia-redis-replication.auth.svc.cluster.local
    port: 6379

# https://www.authelia.com/configuration/storage/introduction/
storage: 
  postgres:
    address: tcp://authelia-17-pg.auth.svc.cluster.local:5432
    database: authelia
    tls:
      skip_verify: true

# https://www.authelia.com/configuration/miscellaneous/introduction/#theme
theme: dark

totp:
  issuer: auth.tswn.us

webauthn:
  display_name: auth.tswn.us
