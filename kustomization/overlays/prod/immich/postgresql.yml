---
apiVersion: acid.zalan.do/v1
kind: postgresql
metadata:
  name: immich-17-pg
spec:
  enableLogicalBackup: true
  # We need spilo with VectorChord.
  # https://github.com/immich-app/immich/discussions/20634#discussion-8681480
  dockerImage: ghcr.io/alexanderbabel/spilo:4.0-p3
  numberOfInstances: 1
  podPriorityClassName: application-infra
  postgresql:
    parameters:
      # Order matters for pg_state_statements and pg_stat_kcache!
      shared_preload_libraries: pg_cron,pg_stat_statements,pg_stat_kcache,vchord
    version: "17"
  resources:
    requests:
      cpu: 50m
      memory: 512Mi
  teamId: immich
  users:
    immich:
      - SUPERUSER
  volume:
    size: 20Gi
    storageClass: longhorn-encrypted-replicated-database
