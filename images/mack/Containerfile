# Allow build scripts to be referenced without being copied into the final image.
FROM scratch AS ctx
COPY build_files /

FROM quay.io/fedora/fedora-bootc:42 as builder
RUN /usr/libexec/bootc-base-imagectl \
    build-rootfs \
    --manifest=standard \
    /target-rootfs

# Create a new, empty image from scratch (literally and figuratively).
FROM scratch
COPY --from=builder /target-rootfs/ /

ARG TARGETPLATFORM

RUN --mount=type=bind,from=ctx,source=/,target=/ctx \
    --mount=type=cache,dst=/var/cache \
    --mount=type=cache,dst=/var/log \
    --mount=type=tmpfs,dst=/tmp \
    /ctx/build.sh

# Verify final image and contents are correct.
RUN bootc container lint

LABEL containers.bootc 1
LABEL ostree.bootable 1
ENV container=oci
STOPSIGNAL SIGRTMIN+3
CMD ["/sbin/init"]
